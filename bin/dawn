#!/usr/bin/env ruby

require 'getoptlong'

require 'codesake_commons'
require 'codesake-dawn'

APPNAME = File.basename($0)
LIST_KNOWN_FRAMEWORK  = %w(rails sinatra) #padrino)
VALID_OUTPUT_FORMAT   = %w(:console :json :csv :html)

logger  = Codesake::Commons::Logging.instance
opts    = GetoptLong.new(
  [ '--rails',                  '-r',   GetoptLong::NO_ARGUMENT],
  [ '--sinatra',                '-s',   GetoptLong::NO_ARGUMENT],
  [ '--padrino',                '-p',   GetoptLong::NO_ARGUMENT],
  [ '--list-known-framework',   '-f',   GetoptLong::NO_ARGUMENT ],
  [ '--list-knowledgebase',     '-k',   GetoptLong::NO_ARGUMENT ],
  [ '--output',                 '-o',   GetoptLong::REQUIRED_ARGUMENT],
  [ '--verbose',                '-V',   GetoptLong::NO_ARGUMENT],
  [ '--version',                '-v',   GetoptLong::NO_ARGUMENT],
  [ '--help',                   '-h',   GetoptLong::NO_ARGUMENT]
)
engine  = nil
options = {:verbose=>false, :output=>:console}

trap("INT")   { logger.die('[INTERRUPTED]') }


opts.each do |opt, val|
  case opt
  when '--version'
    puts "#{Codesake::Dawn::VERSION}"
    Kernel.exit(0)
  when '--rails'
    engine = Codesake::Dawn::Rails.new
  when '--sinatra'
    engine = Codesake::Dawn::Sinatra.new
  when '--padrino'
    puts "sorry padrino is not yet supported"
    Kernel.exit(1)
  when '--verbose'
    options[:verbose]=true
  when '--output'
    options[:output] = val unless VALID_OUTPUT_FORMAT.find_index(val).nil?
  when '--list-knowledgebase'
    kb = Codesake::Dawn::KnowledgeBase.new
    puts "Security checks currently supported:\n\n"

    kb.all.each do |check|
      puts "Name: #{check.name}\tCVSS: #{check.cvss_score}\tReleased: #{check.release_date}"
      puts "Description\n#{check.message}"
      puts "Remediation\n#{check.remediation}\n\n"
    end
    Kernel.exit(0)

  when '--list-known-framework'
    puts "Ruby MVC framework supported by #{APPNAME}:"
    LIST_KNOWN_FRAMEWORK.each do |mvc|
      puts "* #{mvc}"
    end
    Kernel.exit(0)
  end
end

target=ARGV.shift

logger.helo "#{APPNAME} v#{Codesake::Dawn::VERSION} (C) 2013 - paolo@armoredcode.com is starting up"
logger.die "missing target framework option" if engine.nil?
logger.die "missing target" if target.nil?
logger.die "#{target} doesn't exist" unless Dir.exist?(target)

engine.set_target(target) unless engine.nil?
engine.load_knowledge_base

logger.die "nothing to do on #{target}" unless engine.can_apply?
logger.log "scanning #{target}"
logger.log "#{engine.name} v#{engine.get_mvc_version} detected"
logger.log "applying all security checks" 
if engine.apply_all 
  logger.ok "all security checks applied"
else
  logger.err "no security checks in the knowledge base"
end

if engine.vulnerabilities.count != 0

logger.log "#{engine.vulnerabilities.count} vulnerabilities found"
engine.vulnerabilities.each do |vuln|
  logger.err "#{vuln[:name]} failed"
  logger.log "Description: #{vuln[:message]}"
  logger.log "Solution: #{vuln[:remediation]}"
  logger.err "Evidence:"
  vuln[:evidences].each do |evidence|
    logger.err evidence
  end
end
else
  logger.ok "no vulnerabilities found."
end

if engine.mitigated_issues.count != 0
  logger.log "#{engine.mitigated_issues.count} mitigated vulnerabilities found"
  engine.mitigated_issues.each do |vuln|
    logger.ok "#{vuln[:name]} mitigated"
    vuln[:evidences].each do |evidence|
      logger.err evidence
    end
  end
end



logger.helo "#{APPNAME} is shutting down"
Kernel.exit(0)

